#!/bin/bash
# Cloudflared Auto Setup Script
# إعداد Cloudflared Tunnel تلقائي للدومين والسيرفر

# المتغيرات (عدلهم على حسب حالتك)
TUNNEL_NAME="denut-tunnel"
DOMAIN="denutsmp.qzz.io"
SERVICE_PORT="80"

echo "➡️ تحميل cloudflared..."
curl -L https://github.com/cloudflare/cloudflared/releases/latest/download/cloudflared-linux-amd64 -o cloudflared
chmod +x cloudflared
sudo mv cloudflared /usr/local/bin/
cloudflared --version

echo "➡️ تسجيل الدخول في Cloudflare..."
cloudflared tunnel login

echo "➡️ إنشاء Tunnel..."
cloudflared tunnel create $TUNNEL_NAME

# الحصول على الـ Tunnel ID
TUNNEL_ID=$(cat ~/.cloudflared/*.json | grep -o '"TunnelID":"[^"]*' | cut -d'"' -f4)

echo "➡️ إنشاء ملف config.yml..."
mkdir -p ~/.cloudflared
cat > ~/.cloudflared/config.yml <<EOL
tunnel: $TUNNEL_ID
credentials-file: /home/codespace/.cloudflared/$TUNNEL_ID.json

ingress:
  - hostname: $DOMAIN
    service: http://localhost:$SERVICE_PORT
  - service: http_status:404
EOL

echo "➡️ ربط الدومين بالـ tunnel..."
cloudflared tunnel route dns $TUNNEL_NAME $DOMAIN

echo "✅ خلصنا! شغل السيرفر باستخدام:"
echo "cloudflared tunnel run $TUNNEL_NAME"
